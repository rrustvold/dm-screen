<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monster Stats</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        .monster-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        .current-hp-input {
            width: 60px;
            margin-left: 5px;
            display: inline-block;
        }
        .current-hp-label {
            margin-left: 10px;
            display: inline-block;
        }
        .attack-bonus {
            cursor: pointer;
            text-decoration: underline;
            color: #2196F3;
        }
        .attack-button {
            display: inline-block;
            padding: 2px 8px;
            margin: 0 4px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
        }
        .attack-button:hover {
            background-color: #1976D2;
        }
        .dice-result {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 6px;
            background-color: #e3f2fd;
            border-radius: 3px;
            font-family: monospace;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .dice-result.animate {
            animation: fadeIn 0.3s;
        }
    </style>
</head>
<body>
    <iframe id="monsterFrame" class="monster-frame"></iframe>

    <script>
        function rollD20(bonus) {
            const roll = Math.floor(Math.random() * 20) + 1;
            const total = roll + bonus;
            return { roll, total };
        }

        // Get the monster page URL from the query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const monsterPage = urlParams.get('monster');
        
        if (monsterPage) {
            const frame = document.getElementById('monsterFrame');
            frame.src = monsterPage;

            // Once the iframe loads, inject the HP tracker and attack roll functionality
            frame.onload = function() {
                try {
                    const content = frame.contentDocument;
                    
                    // Add HP tracking
                    const hpElements = content.querySelectorAll('li');
                    for (const el of hpElements) {
                        if (el.textContent.includes('Hit Points')) {
                            // Create the current HP elements
                            const currentHpLabel = document.createElement('span');
                            currentHpLabel.className = 'current-hp-label';
                            currentHpLabel.textContent = '(Current: ';
                            
                            const currentHpInput = document.createElement('input');
                            currentHpInput.type = 'number';
                            currentHpInput.className = 'current-hp-input';
                            currentHpInput.id = 'currentHp';
                            
                            const closingSpan = document.createElement('span');
                            closingSpan.textContent = ')';
                            
                            // Extract max HP value
                            const hpMatch = el.textContent.match(/(\d+)/);
                            if (hpMatch) {
                                const maxHp = parseInt(hpMatch[1]);
                                
                                // Check for saved HP first
                                const savedHp = localStorage.getItem(`hp_${monsterPage}`);
                                // Only use maxHp if there's no saved value
                                if (savedHp === null) {
                                    currentHpInput.value = maxHp;
                                    // Save the initial max HP value
                                    localStorage.setItem(`hp_${monsterPage}`, maxHp);
                                } else {
                                    currentHpInput.value = savedHp;
                                }
                                
                                // Save HP changes to localStorage
                                currentHpInput.addEventListener('change', function(e) {
                                    localStorage.setItem(`hp_${monsterPage}`, e.target.value);
                                });
                                
                                // Add a "Reset" link to set HP back to max
                                const resetLink = document.createElement('a');
                                resetLink.href = '#';
                                resetLink.textContent = ' (reset)';
                                resetLink.style.fontSize = '0.8em';
                                resetLink.style.marginLeft = '5px';
                                resetLink.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    currentHpInput.value = maxHp;
                                    localStorage.setItem(`hp_${monsterPage}`, maxHp);
                                });
                                
                                // Inject the elements into the monster stat block
                                el.appendChild(currentHpLabel);
                                el.appendChild(currentHpInput);
                                el.appendChild(closingSpan);
                                el.appendChild(resetLink);
                            }
                            break;
                        }
                    }

                    // Add attack roll functionality
                    const actionElements = content.querySelectorAll('li');
                    actionElements.forEach(el => {
                        const text = el.innerHTML;
                        // Look for attack bonus patterns like "+2 to hit" or "+6 to hit"
                        const attackBonusMatch = text.match(/([+-]\d+) to hit/);
                        if (attackBonusMatch) {
                            const attackBonus = parseInt(attackBonusMatch[1]);
                            
                            // Replace the attack bonus with a button
                            el.innerHTML = text.replace(
                                attackBonusMatch[0],
                                `<button class="attack-button" title="Click to roll d20${attackBonusMatch[1]}">${attackBonusMatch[0]}</button>`
                            );

                            // Add click handler for the attack button
                            const attackButton = el.querySelector('.attack-button');
                            attackButton.addEventListener('click', function(e) {
                                e.preventDefault(); // Prevent any form submission
                                
                                // Remove any existing dice results
                                const existingResult = el.querySelector('.dice-result');
                                if (existingResult) {
                                    existingResult.remove();
                                }

                                // Roll the dice and show the result
                                const { roll, total } = rollD20(attackBonus);
                                const resultSpan = document.createElement('span');
                                resultSpan.className = 'dice-result';
                                resultSpan.textContent = `[${roll} + ${attackBonus} = ${total}]`;
                                
                                // Insert the result after the button
                                attackButton.insertAdjacentElement('afterend', resultSpan);
                                
                                // Trigger animation
                                void resultSpan.offsetWidth; // Force reflow
                                resultSpan.classList.add('animate');
                            });
                        }
                    });

                } catch (e) {
                    console.error('Could not access iframe content:', e);
                }
            };
        }
    </script>
</body>
</html>